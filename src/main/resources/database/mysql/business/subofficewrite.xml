<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="comle.SubofficeWrite">
	<resultMap type="com.lion.echart.Suboffice.entity.SubofficeWriteEntity" id="subofficeWrite">
		<id property="subofficeWriteId" column="subofficewriteid"/>
		<result property="contractId" column="contractid"/>
		<result property="constructionContent" column="constructioncontent"/>
		<result property="beginDate" column="begindate"/>
		<result property="planFinishDate" column="planfinishdate"/>
		<result property="budgetInvest" column="budgetinvest"/>
		<result property="contractAmount" column="contractamount"/>
		<result property="finishInvest" column="finishinvest"/>
		<result property="surplusInvest" column="surplusinvest"/>
		<result property="yearPlanInvest" column="yearplaninvest"/>
		<result property="monthPlanInvest" column="monthplaninvest"/>
		<result property="yearRealityInvest" column="yearrealityinvest"/>
		<result property="monthRealityInvest" column="monthrealityinvest"/>
		<result property="tendayRealityInvest" column="tendayrealityinvest"/>
		<result property="earthwork" column="earthwork"/>
		<result property="stonework" column="stonework"/>
		<result property="beton" column="beton"/>
		<result property="overallImageProgress" column="overallimageprogress"/>
		<result property="nextMonthPlanInvest" column="nextmonthplaninvest"/>
		<result property="remark" column="remark"/>
		<result property="priority" column="priority"/>
		<result property="isDisabled" column="isdisabled"/>
		<result property="operUser" column="operuser"/>
		<result property="nextMonthPlanInvest" column="nextmonthplaninvest"/>
		<result property="year" column="year"/>
		<result property="month" column="month"/>
		<result property="operDate" column="operdate" jdbcType="DATE"/>
	</resultMap>
	
	<!-- 仅供分局填报查询列表使用 -->
	<select id="getSubofficewriteListData" parameterType="java.util.Map" resultType="java.util.Map" >
		select 
			sw.*,ct.contractname,ct.contractnum,ct.subofficeid,ct.amount contractamount,
			DATE_FORMAT(sw.begindate, '%Y-%m-%d') begindatestr,
			DATE_FORMAT(sw.planfinishdate, '%Y-%m-%d') planfinishdatestr
		from t_s_subofficewrite sw,t_c_contract ct where sw.contractid = ct.contractid
		<!-- 0为系统管理员，可以看到所有分局，其他情况下，各分局只能看到自己分局的数据 -->
		<if test="subofficeid != 0">
			and subofficeid = #{subofficeid} 
		</if>
	</select>
	
	<insert id="subofficewriteInsert" parameterType="com.lion.echart.Suboffice.entity.SubofficeWriteEntity">
           insert into t_s_subofficewrite(contractid, constructioncontent, begindate, planfinishdate, 
           	budgetinvest, finishinvest, surplusinvest, yearplaninvest, monthplaninvest, yearrealityinvest, monthrealityinvest, tendayrealityinvest,
           	earthwork, stonework, beton, overallimageprogress, nextmonthplaninvest, remark, 
           	year, month, priority, isdisabled, operuser, operdate)  
               values( #{contractid},  #{constructioncontent},  str_to_date(#{begindate},'%Y-%m-%d %H'), str_to_date(#{planfinishdate},'%Y-%m-%d %H'),
               #{budgetinvest},  #{finishinvest},  #{surplusinvest},  #{yearplaninvest},  #{monthplaninvest},  #{yearrealityinvest},  #{monthrealityinvest},  #{tendayrealityinvest},
               #{earthwork}, #{stonework}, #{beton}, #{overallimageprogress}, #{nextmonthplaninvest}, #{remark}, 
           	   #{year}, #{month}, #{priority}, #{isdisabled}, #{operuser}, #{operdate})
   	</insert>

	<update id="subofficewriteUpdate" parameterType="com.lion.echart.Suboffice.entity.SubofficeWriteEntity">
    	update t_s_subofficewrite
    	set contractid = #{contractid},constructioncontent = #{constructioncontent},begindate = #{begindate},planfinishdate = #{planfinishdate},
    		budgetinvest = #{budgetinvest},finishinvest = #{finishinvest},surplusinvest = #{surplusinvest},yearplaninvest = #{yearplaninvest},
    		monthplaninvest = #{monthplaninvest},yearrealityinvest = #{yearrealityinvest},monthrealityinvest = #{monthrealityinvest},tendayrealityinvest = #{tendayrealityinvest},
    		earthwork = #{earthwork},stonework = #{stonework},beton = #{beton},overallimageprogress = #{overallimageprogress},nextmonthplaninvest = #{nextmonthplaninvest},remark = #{remark},
    		year = #{year},month = #{month},priority = #{priority},isdisabled = #{isdisabled},operuser = #{operuser},operdate = #{operdate}
    	where subofficewriteid = #{subofficewriteid}
    </update>
    
    <!-- 校验当月提报的数据 -->
	<select id="subofficewritecheck" parameterType="java.util.Map" resultType="java.util.Map" >
		select ct.contractname,yearrealityinvest,finishinvest,
			(select sum(monthrealityinvest) from t_s_subofficewrite where contractid = sw.contractid 
				and year = sw.year and month <![CDATA[<=]]> sw.month) as fornowsumyear,
			(select sum(monthrealityinvest) from t_s_subofficewrite where contractid = sw.contractid 
				and (year <![CDATA[<]]> sw.year or (year = sw.year and month <![CDATA[<=]]> sw.month))) as fornowall
		  from t_s_subofficewrite sw 
		join t_c_contract ct on sw.contractid = ct.contractid
		<if test="ids.size()!=0">
			and sw.subofficewriteid in
			<foreach collection="ids" index="index" item="item" open="(" separator="," close=")">
			#{item}
			</foreach>
		</if>
	</select>
</mapper>