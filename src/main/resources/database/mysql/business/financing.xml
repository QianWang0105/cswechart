<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="comle.financing">
	<select id="getfinancingListData" parameterType="java.util.Map" resultType="java.util.Map" >
		select t.key as costType,t.value as costTypeStr
			,t.maintype as mainType,t.maintypedescribe as mainTypeStr
			,st.writeyear as year,sum(st.money) as total
		from t_s_code t 
		 left join t_f_financingwrite st on t.key = st.costtype
	       and st.writeyear = #{writeyear} and st.isdisabled = 0
		where t.codetype = 'costtype' 
	    group by t.key,t.value,t.maintype,t.maintypedescribe ,st.writeyear
	    order by t.orderby
	</select>
	
	<select id="getflistDetailData" parameterType="java.util.Map" resultType="java.util.Map" >
		select t.*
		from t_f_financingwrite t 
		left join t_s_code st on t.costtype = st.key
			and st.codetype = 'costtype' 
		where t.isdisabled = '0' and t.writeyear = #{year} and t.costtype = #{costtype}
	</select>
	
	<insert id="financingWriteInsert" parameterType="com.lion.echart.financing.entity.FinancingWriteEntity">
           insert into t_f_financingwrite(payfordate, costtype, maintype, contractid, 
           	subofficeid, money, operdate, operuser, writeyear, writemonth, cashierno, voucherno) 
               values(str_to_date(#{payfordateStr},'%Y-%m-%d %H'), #{costtype}, #{maintype}, #{contractid}, 
            #{subofficeid}, #{money}, now(), #{operuser}, #{writeyear}, #{writemonth}, #{cashierno}, #{voucherno})
   	</insert>
	
	<update id="financingWriteUpdate" parameterType="com.lion.echart.financing.entity.FinancingWriteEntity">
    	update t_f_financingwrite
    		set 
    		 payfordate = #{payfordate}
    		,costtype = #{costtype}
    		,maintype = #{maintype}
    		,contractid = #{contractid}
    		,subofficeid = #{subofficeid}
    		,money = #{money}
    		,operdate = now()
    		,operuser = #{operuser}
    		,writeyear = #{writeyear}
    		,writemonth = #{writemonth}
    		,cashierno = #{cashierno}
    		,voucherno  = #{voucherno}
    	where id = #{id}
    </update>
    
	<delete id="financingWriteDelete" parameterType="com.lion.echart.financing.entity.FinancingWriteEntity" >
		update t_f_financingwrite
    		set isdisabled = 1
    	where id = #{id}
    </delete>
    
    <select id="getFinancingReportData" parameterType="java.util.Map" resultType="java.util.Map" >
	select tt.*,(money1+money2+money3+money4) as moneys from ( 
		select t.value as costTypeStr,t.maintypedescribe as mainTypeStr
			,sum(st1.money) as money1,sum(st2.money) as money2
			,sum(st3.money) as money3,sum(st4.money) as money4
		from t_s_code t 
		 left join t_f_financingwrite st1 on t.key = st1.costtype
	       and st1.writeyear = #{year1} and st1.isdisabled = 0
		 left join t_f_financingwrite st2 on t.key = st2.costtype
	       and st2.writeyear = #{year2} and st2.isdisabled = 0
		 left join t_f_financingwrite st3 on t.key = st3.costtype
	       and st3.writeyear = #{year3} and st3.writemonth <![CDATA[<=]]> #{month} and st3.isdisabled = 0
		 left join t_f_financingwrite st4 on t.key = st4.costtype
	       and st4.writeyear = #{year3} and st4.writemonth = #{month} and st4.isdisabled = 0
		where t.codetype = 'costtype' 
	    group by t.key,t.value,t.maintype,t.maintypedescribe 
	    order by t.orderby ) tt
	</select>
    
</mapper>