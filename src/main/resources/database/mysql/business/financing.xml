<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="comle.financing">
	<select id="getfinancingListData" parameterType="java.util.Map" resultType="java.util.Map" >
		select t.key as costType,t.value as costTypeStr
			,t.maintype as mainType,t.maintypedescribe as mainTypeStr
			,st.writeyear as year,sum(st.money) as total
		from t_s_code t 
		 left join t_f_financingwrite st on t.key = st.costtype
	       and st.writeyear = #{writeyear} and st.isdisabled = 0
		where t.codetype = 'costtype' 
	    group by t.key,t.value,t.maintype,t.maintypedescribe ,st.writeyear
	    order by t.orderby
	</select>
	
	<select id="getflistDetailData" parameterType="java.util.Map" resultType="java.util.Map" >
		select t.*
		from t_f_financingwrite t 
		left join t_s_code st on t.costtype = st.key
			and st.codetype = 'costtype' 
		where t.isdisabled = '0' and t.writeyear = #{year} and t.costtype = #{costtype}
	</select>
	
	<insert id="financingWriteInsert" parameterType="com.lion.echart.financing.entity.FinancingWriteEntity">
           insert into t_f_financingwrite(payfordate, costtype, maintype, contractid, 
           	subofficeid, money, operdate, operuser, writeyear, writemonth, cashierno, voucherno) 
               values(str_to_date(#{payfordateStr},'%Y-%m-%d %H'), #{costtype}, #{maintype}, #{contractid}, 
            #{subofficeid}, #{money}, now(), #{operuser}, #{writeyear}, #{writemonth}, #{cashierno}, #{voucherno})
   	</insert>
	
	<update id="financingWriteUpdate" parameterType="com.lion.echart.financing.entity.FinancingWriteEntity">
    	update t_f_financingwrite
    		set 
    		 payfordate = #{payfordate}
    		,costtype = #{costtype}
    		,maintype = #{maintype}
    		,contractid = #{contractid}
    		,subofficeid = #{subofficeid}
    		,money = #{money}
    		,operdate = now()
    		,operuser = #{operuser}
    		,writeyear = #{writeyear}
    		,writemonth = #{writemonth}
    		,cashierno = #{cashierno}
    		,voucherno  = #{voucherno}
    	where id = #{id}
    </update>
    
	<delete id="financingWriteDelete" parameterType="com.lion.echart.financing.entity.FinancingWriteEntity" >
		update t_f_financingwrite
    		set isdisabled = 1
    	where id = #{id}
    </delete>
    
    <select id="getFinancingReportData" parameterType="java.util.Map" resultType="java.util.Map" >
      select @rownum:=@rownum+1 as rnum,mmtt.* from (select mt.value as costTypeStr,tt.*,ifnull(st4.money,0) as moneysi,
      	(moneyyi+moneyer+moneysan) as moneys from t_s_code mt
		left join ( select t.key
			,ifnull(sum(st1.money),0) as moneyyi,ifnull(sum(st2.money),0) as moneyer
			,ifnull(sum(st3.money),0) as moneysan
		from t_s_code t 
		 left join t_f_financingwrite st1 on t.key = st1.costtype
	       and st1.writeyear = #{year1} and st1.isdisabled = 0
		 left join t_f_financingwrite st2 on t.key = st2.costtype
	       and st2.writeyear = #{year2} and st2.isdisabled = 0
		 left join t_f_financingwrite st3 on t.key = st3.costtype
	       and st3.writeyear = #{year3} and st3.writemonth <![CDATA[<=]]> #{month} and st3.isdisabled = 0
		where t.codetype = 'costtype' 
	    group by t.key ) tt on mt.key = tt.key
		 left join (select costtype,sum(money) as money from t_f_financingwrite
						where writeyear = #{year3} and writemonth = #{month} and isdisabled = 0 group by costtype)
			st4 on tt.key = st4.costtype
			where mt.codetype = 'costtype' 
			order by orderby ) mmtt ,(select @rownum:=0) rt
	</select>
    
</mapper>